# This is a Bazel genrule script. It acts like Bash, but has some extra
# substitutions for locating dependencies.
#
# https://docs.bazel.build/versions/master/be/general.html#genrule

cat "$(location :lightstep_compiler_flags)"
source "$(location :lightstep_compiler_flags)"

SOURCE_DIR=`dirname "$${PWD}/$(location :CMakeLists.txt)"`
PROTOC="$${PWD}/$(location @com_google_protobuf//:protoc)"
PROTOBUF_SRC="$${PWD}/external/com_google_protobuf/src/"
PROTOBUF_LIBDIR="$${PWD}/$(BINDIR)/external/com_google_protobuf/"
OPENTRACING_LIBRARY="$${PWD}/$(location @com_github_opentracing_opentracing_cpp//:opentracing_library)"
OPENTRACING_INCLUDE_DIR="`dirname $${OPENTRACING_LIBRARY}`/../include"
mkdir -p "$(@D)/build"
cd "$(@D)/build"
CC=""
cmake  \
  -DCMAKE_BUILD_TYPE=Release \
  -DCMAKE_INSTALL_PREFIX="$${PWD}/../_prefix" \
  -DBUILD_TESTING=OFF \
  -DWITH_GRPC=OFF \
  -DPROTOBUF_LIBRARY="$${PROTOBUF_LIBDIR}/libprotobuf.a" \
  -DPROTOBUF_IMPORT_DIRS="$${PROTOBUF_SRC}" \
  -DPROTOBUF_INCLUDE_DIR="$${PROTOBUF_SRC}" \
  -DPROTOBUF_PROTOC_EXECUTABLE="$${PROTOC}" \
  -DOPENTRACING_INCLUDE_DIR="$${OPENTRACING_INCLUDE_DIR}" \
  -DOPENTRACING_LIBRARY="$${OPENTRACING_LIBRARY}" \
  "$${SOURCE_DIR}"
make V=1 install
